<app-navbar></app-navbar>

<p-toast></p-toast>

<div class="container">
  <p-card header="Carga y Visualización de Datos" class="mt-4">
    <div class="card-container">

      <!-- 1. Carga de archivo CSV -->
      <p-fileUpload
        mode="basic"
        chooseLabel="Seleccionar CSV"
        accept=".csv"
        [auto]="true"
        [showUploadButton]="false"
        [showCancelButton]="false"
        (onSelect)="onFileSelect($event)"
        class="mb-3">
      </p-fileUpload>

      <!-- 2. Carga de archivo XLSX -->
      <p-fileUpload
        mode="basic"
        chooseLabel="Seleccionar XLSX"
        accept=".xlsx"
        [auto]="true"
        [showUploadButton]="false"
        [showCancelButton]="false"
        (onSelect)="onXLSXSelect($event)"
        class="mb-4">
      </p-fileUpload>

      <!-- 3. Preview y selección XLSX -->
      <div *ngIf="xlsxFile">
        <div class="mb-2">
          <strong>Vista previa de datos XLSX</strong>
          <div class="mb-2">
            <label>Hoja:</label>
            <p-select [(ngModel)]="xlsxSelectedSheet"
                      [options]="xlsxSheetNames"
                      (onChange)="onXLSXSheetChange()"
                      [style]="{width:'220px', display:'inline-block'}">
              <ng-template let-option pTemplate="item">{{ option }}</ng-template>
            </p-select>
            <label class="ml-3">Fila de encabezado:</label>
            <p-select [(ngModel)]="xlsxHeaderRow"
                      [options]="xlsxHeaderRowOptions"
                      (onChange)="onXLSXHeaderRowChange()"
                      [style]="{width:'80px', display:'inline-block'}">
              <ng-template let-option pTemplate="item">{{ option + 1 }}</ng-template>
            </p-select>
          </div>
        </div>
        <table class="xlsx-preview-table">
          <tr *ngFor="let row of xlsxPreview">
            <td *ngFor="let cell of row">{{ cell }}</td>
          </tr>
        </table>
        <div class="mt-2">
          <label>Columnas a usar:</label>
          <p-multiSelect
            [options]="xlsxHeaders"
            [(ngModel)]="xlsxSelectedColumns"
            optionLabel=""
            defaultLabel="Selecciona columnas"
            [style]="{width:'320px'}">
            <ng-template let-option pTemplate="item">{{ option }}</ng-template>
          </p-multiSelect>
          <button type="button" class="ml-2" pButton label="Usar columnas" (click)="useXLSXColumns()"
                  [disabled]="!xlsxSelectedColumns.length"></button>
        </div>
        <div *ngIf="xlsxWarnNonNumeric" class="warn-non-numeric mt-2">
          <i class="pi pi-exclamation-triangle"></i>
          <span>¡Advertencia! Hay columnas o datos no numéricos, algunas funciones estadísticas pueden no funcionar correctamente.</span>
        </div>
        <hr>
      </div>

      <!-- 4. Tabla solo si hay datos -->
      <div *ngIf="csvData.length > 0" class="csv-data-section">
        <p-toolbar class="mb-3">
          <ng-template pTemplate="start">
            <span class="font-bold">Total de registros: {{ csvData.length }}</span>
          </ng-template>
        </p-toolbar>

        <p-table
          #dt
          [value]="paginatedData"
          [tableStyle]="{ 'min-width': '50rem' }"
          class="p-datatable-striped"
        >
          <!-- Cabecera -->
          <ng-template pTemplate="header">
            <tr>
              <ng-container *ngFor="let header of csvHeaders; trackBy: trackHeader">
                <th pSortableColumn="{{ header }}">
                  {{ header }}
                  <p-sortIcon field="{{ header }}"></p-sortIcon>
                </th>
              </ng-container>
            </tr>
          </ng-template>
          <!-- Cuerpo -->
          <ng-template pTemplate="body" let-rowData>
            <tr>
              <ng-container *ngFor="let header of csvHeaders; trackBy: trackHeader">
                <td>{{ rowData[header] }}</td>
              </ng-container>
            </tr>
          </ng-template>
          <!-- Sin datos -->
          <ng-template pTemplate="emptymessage">
            <tr>
              <td [attr.colspan]="csvHeaders.length" style="text-align: center;">
                No se encontraron datos.
              </td>
            </tr>
          </ng-template>
        </p-table>

        <!-- PAGINADOR -->
        <div class="flex justify-content-end mt-2">
          <p-paginator
            [first]="first"
            [rows]="rows"
            [totalRecords]="csvData.length"
            [rowsPerPageOptions]="[5, 10, 20, 50]"
            [showCurrentPageReport]="true"
            [showPageLinks]="true"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} entradas"
            (onPageChange)="onPageChange($event)">
          </p-paginator>
        </div>

        <!-- Estadísticas descriptivas -->
        <div *ngIf="descriptiveStats.length > 0" class="mt-4">
          <p-card header="Estadísticas Descriptivas">
            <p-table
              [value]="descriptiveStats"
              [tableStyle]="{ 'min-width': '40rem' }"
              class="p-datatable-striped stats-table"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th>Columna</th>
                  <th>Cantidad</th>
                  <th>Media</th>
                  <th>Mediana</th>
                  <th>Moda</th>
                  <th>Mínimo</th>
                  <th>Máximo</th>
                  <th>Desviación</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-stat>
                <tr>
                  <td>{{ stat.columna }}</td>
                  <td>{{ stat.cantidad }}</td>
                  <td>{{ stat.media | number:'1.2-2' }}</td>
                  <td>{{ stat.mediana | number:'1.2-2' }}</td>
                  <td>{{ stat.moda }}</td>
                  <td>{{ stat.minimo }}</td>
                  <td>{{ stat.maximo }}</td>
                  <td>{{ stat.desviacion | number:'1.2-2' }}</td>
                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="8" style="text-align: center;">
                    No hay estadísticas disponibles.
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </p-card>
        </div>
      </div>
    </div>
  </p-card>
</div>

<!-- Diálogo de resultados -->
<p-dialog
  header="Resultado de la operación"
  [(visible)]="mostrarDialogoResultado"
  [modal]="true"
  [style]="{ width: '450px' }"
  [draggable]="false"
  [resizable]="false">
  <p class="m-0">{{ resultadoOperacion }}</p>
  <ng-template pTemplate="footer">
    <p-button icon="pi pi-check" label="Aceptar" (onClick)="mostrarDialogoResultado = false" class="p-button-text"></p-button>
  </ng-template>
</p-dialog>
